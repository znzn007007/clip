# é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆæ€»ç»“

**Date:** 2026-01-18

---

## ä¸€ã€ä»Šå¤©æµ‹è¯•ä¸­å‘ç°çš„é—®é¢˜

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|----------|------|
| 1 | **é¡µé¢ç­‰å¾…ç­–ç•¥ä¸å½“** - ä½¿ç”¨ `waitUntil: 'commit'` åªç­‰å¾…é¡µé¢æäº¤ï¼ŒJS æœªæ‰§è¡Œå®Œæˆ | æ”¹ä¸º `waitUntil: 'load'` + 3ç§’å»¶è¿Ÿ | âœ… å·²ä¿®å¤ |
| 2 | **æ¨æ–‡æ–‡æœ¬æœªæå–** - HTML ä¸­æ²¡æœ‰ `[data-testid="tweetText"]` å±æ€§ | æ·»åŠ å¤šç§æå–æ–¹æ³•ï¼š`tweetText` â†’ `longformRichTextComponent` â†’ å…œåº•æ–¹æ¡ˆ | âœ… å·²ä¿®å¤ |
| 3 | **å›¾ç‰‡æœªä¸‹è½½** - `AssetDownloader` åªè¿”å›æ˜ å°„ï¼Œæœªå®é™…ä¸‹è½½æ–‡ä»¶ | å¾…å®ç°ä¸‹è½½é€»è¾‘ | â³ å¾…å®Œæˆ |

### è¯¦ç»†è¯´æ˜

#### 1. é¡µé¢ç­‰å¾…ç­–ç•¥é—®é¢˜

**ç—‡çŠ¶:** Twitter æ¨æ–‡å†…å®¹æ— æ³•æå–ï¼ŒHTML åªåŒ…å«æ¡†æ¶ä»£ç 

**åŸå› :** `page.ts:25-26` ä½¿ç”¨ `waitUntil: 'commit'`ï¼Œè¿™åªç­‰å¾…é¡µé¢å¼€å§‹åŠ è½½ï¼Œä¸ç­‰å¾… JS æ‰§è¡Œå®Œæˆ

**è§£å†³æ–¹æ¡ˆ:**
```typescript
// ä¿®æ”¹å‰
await page.goto(url, {
  waitUntil: 'commit',
  timeout,
});

// ä¿®æ”¹å
await page.goto(url, {
  waitUntil: 'load',
  timeout,
});
await page.waitForTimeout(3000); // ç­‰å¾…åŠ¨æ€å†…å®¹
```

#### 2. æ¨æ–‡æ–‡æœ¬æå–é—®é¢˜

**ç—‡çŠ¶:** æ¨æ–‡åªèƒ½æå–å›¾ç‰‡å’Œé“¾æ¥ï¼Œæ–‡å­—å†…å®¹ä¸ºç©º

**åŸå› :** HTML ä¸­æ²¡æœ‰ `[data-testid="tweetText"]` å±æ€§ï¼Œé•¿æ¨æ–‡ä½¿ç”¨ `longformRichTextComponent`

**è§£å†³æ–¹æ¡ˆ:**
```typescript
// src/core/extract/adapters/twitter/dom-extractor.ts
// æ·»åŠ ä¸‰ç§æ–‡æœ¬æå–æ–¹æ³•ï¼š

// Method 1: æ ‡å‡†æ¨æ–‡
const textEl = article.querySelector('[data-testid="tweetText"]');

// Method 2: é•¿æ¨æ–‡ç»„ä»¶
const longformEl = article.querySelector('[data-testid="longformRichTextComponent"]');
const textSpans = longformEl.querySelectorAll('span[data-text="true"]');

// Method 3: å…œåº•æ–¹æ¡ˆ
// æ’é™¤äº¤äº’å…ƒç´ ï¼Œæå–æ‰€æœ‰æ–‡æœ¬
```

---

## äºŒã€Twitter é€‚é…å™¨é—®é¢˜

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|----------|------|
| 1 | **å•æºæ•°æ®æå–ä¸è¶³** - åªä¾èµ– `window.__STATE__`ï¼Œå®¹æ˜“å¤±è´¥ | å®ç°å¤šæºæå–ï¼š`__STATE__` â†’ `__INITIAL_STATE__` â†’ script tags | âœ… å·²ä¿®å¤ |
| 2 | **DOM æå–å™¨æ–‡æœ¬é€‰æ‹©å™¨å¤±æ•ˆ** - `[data-testid="tweetText"]` åœ¨æŸäº›æ¨æ–‡ä¸­ä¸å­˜åœ¨ | æ·»åŠ é•¿æ¨æ–‡ç»„ä»¶é€‰æ‹©å™¨å’Œå…œåº•æ–¹æ¡ˆ | âœ… å·²ä¿®å¤ |
| 3 | **Twitter è®¤è¯å¢™** - æœªç™»å½•æ—¶è¿”å›ç™»å½•é¡µé¢ | ä½¿ç”¨æŒä¹…åŒ– session ä¿ç•™ç™»å½•çŠ¶æ€ | âœ… å·²å®ç° |
| 4 | **parseFromRawState ä¸ºç©ºå®ç°** - è¿”å›ç©ºæ•°ç»„ | å®ç°å®Œæ•´çš„å¤šæºæ•°æ®è§£æ | âœ… å·²ä¿®å¤ |

### å·²å®ŒæˆåŠŸèƒ½

- âœ… å¤šæºæ•°æ®æå– (`TwitterRawExtractor`)
- âœ… DOM æå–å™¨ (`TwitterDomExtractor`)
- âœ… Debug æ¨¡å¼ (`--debug` ä¿å­˜ HTML/JSON)
- âœ… åŸå›¾è´¨é‡è·å– (`&name=orig`)
- âœ… æŒä¹…åŒ–ç™»å½• session

---

## ä¸‰ã€çŸ¥ä¹é€‚é…å™¨é—®é¢˜

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|----------|------|
| 1 | **åçˆ¬è™«é™åˆ¶** - é”™è¯¯ç  40362 "æ‚¨å½“å‰è¯·æ±‚å­˜åœ¨å¼‚å¸¸ï¼Œæš‚æ—¶é™åˆ¶æœ¬æ¬¡è®¿é—®" | æ·»åŠ  RATE_LIMITED é”™è¯¯ç æ£€æµ‹ï¼Œè®¡åˆ’ä½¿ç”¨ CDP è¿æ¥ | âœ… å·²æ£€æµ‹ |
| 2 | **parseFromRawState æœªå®ç°** - è¿”å› null (stub) | å¾…å®ç°ä» `__INITIAL_STATE__` è§£æ | â³ å¾…å®Œæˆ |
| 3 | **é—®ç­”é¡µé¢æ ‡é¢˜é‡å¤** - é—®é¢˜æ ‡é¢˜å‡ºç°ä¸¤æ¬¡ï¼ˆæ–‡æ¡£æ ‡é¢˜+å†…å®¹ä¸­ï¼‰ | ç§»é™¤å†…å®¹ä¸­çš„é—®é¢˜æ ‡é¢˜ï¼Œåªåœ¨æ–‡æ¡£æ ‡é¢˜æ˜¾ç¤ºé—®é¢˜+ç­”ä¸» | âœ… å·²ä¿®å¤ |
| 4 | **æ ‡é¢˜é‡å¤æ¨¡å¼** - "å¦‚ä½•è¯„ä»·å‰ç«¯å·²æ­»ï¼Ÿå¦‚ä½•è¯„ä»·å‰ç«¯å·²æ­»ï¼Ÿ" | æ·»åŠ  `deduplicateTitle` æ–¹æ³•å»é™¤é‡å¤ | âœ… å·²ä¿®å¤ |
| 5 | **ä½œè€…åæå–å¤±è´¥** - `.AuthorInfo-name` æœ‰æ—¶æ— æ³•è·å–å®Œæ•´ä½œè€…å | æ·»åŠ å¤šé€‰æ‹©å™¨ fallbackï¼š`.AuthorInfo-name` â†’ `.UserLink-link` â†’ `[itemprop="name"]` | âœ… å·²ä¿®å¤ |
| 6 | **Debug æ–‡ä»¶åç¡¬ç¼–ç ** - åªæ”¯æŒ Twitter å¹³å° | æ”¹ä¸º `debug-{platform}-*` åŠ¨æ€å‘½å | âœ… å·²ä¿®å¤ |

### éœ€è¦æ£€æŸ¥çš„é€‰æ‹©å™¨

```typescript
// Answer page
$('h1.QuestionHeader-title')
$('.RichContent-inner')
$('.AuthorInfo-name')
$('.VoteButton--up .VoteCount')

// Article page
$('.Post-Title')
$('.Post-RichText')
```

---

## å››ã€æµè§ˆå™¨/é€šç”¨é—®é¢˜

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|----------|------|
| 1 | **CDP è¿æ¥åŠŸèƒ½æœªå®ç°** - CLI æœ‰ `--cdp` é€‰é¡¹ï¼Œä½†ä»£ç æœªå®é™…ä½¿ç”¨ | `BrowserManager.launch()` æœªå®ç°è¿æ¥é€»è¾‘ | â³ å¾…å®Œæˆ |
| 2 | **networkidle è¶…æ—¶** - Twitter æŒç»­æœ‰è½®è¯¢æ´»åŠ¨ï¼Œæ°¸è¿œè¾¾ä¸åˆ° networkidle | ä½¿ç”¨ `load` äº‹ä»¶ + å›ºå®šå»¶è¿Ÿæ›¿ä»£ | âœ… å·²ä¿®å¤ |
| 3 | **æµè§ˆå™¨æŒ‡çº¹æ£€æµ‹** - å¯èƒ½è¢«è¯†åˆ«ä¸ºè‡ªåŠ¨åŒ–å·¥å…· | å¯é€‰ï¼šæ”¹è¿› UAã€æ·»åŠ éšæœºå»¶è¿Ÿã€æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º | â³ å¾…å®Œæˆ |
| 4 | **å›¾ç‰‡ä¸‹è½½æœªå®ç°** - `AssetDownloader.downloadImages()` åªæœ‰æ³¨é‡Š | å¾…ä½¿ç”¨ Playwright å®ç°å®é™…ä¸‹è½½ | â³ å¾…å®Œæˆ |

### CDP è¿æ¥å®ç°å‚è€ƒ

```typescript
// éœ€è¦åœ¨ BrowserManager ä¸­å®ç°
if (options?.cdpEndpoint) {
  // è¿æ¥åˆ°ç°æœ‰æµè§ˆå™¨
  const browser = await chromium.connectOverCDP(options.cdpEndpoint);
  this.context = await browser.newContext();
} else {
  // å¯åŠ¨æ–°æµè§ˆå™¨ï¼ˆå½“å‰å®ç°ï¼‰
  this.context = await chromium.launchPersistentContext(...);
}
```

---

## äº”ã€æ¶æ„/è®¾è®¡é—®é¢˜

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|----------|------|
| 1 | **ç¼ºä¹å•å…ƒæµ‹è¯•** - Zhihu adapter æ²¡æœ‰æµ‹è¯•è¦†ç›– | å‚è€ƒ Twitter adapter æ·»åŠ æµ‹è¯• | â³ å¾…å®Œæˆ |
| 2 | **é”™è¯¯å¤„ç†ä¸å®Œå–„** - TwitterExtractError éœ€è¦æ›´è¯¦ç»†çš„é”™è¯¯ç±»å‹ | å·²å¢å¼ºé”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ | âœ… å·²å®Œæˆ |
| 3 | **è°ƒè¯•åŠŸèƒ½ä¸è¶³** - éš¾ä»¥æ’æŸ¥æå–å¤±è´¥åŸå›  | æ·»åŠ  `--debug` æ¨¡å¼ï¼Œä¿å­˜ HTML å’Œ JSON å¿«ç…§ | âœ… å·²å®Œæˆ |

---

## å…­ã€å¾…å®ç°åŠŸèƒ½

**æ›´æ–°:** å¾®ä¿¡å…¬ä¼—å·é€‚é…å™¨å·²å®Œæˆå¹¶éªŒè¯ï¼Œç§»å‡ºå¾…å®ç°åˆ—è¡¨ã€‚

| # | åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|---|------|------|--------|
| 1 | **CDP è¿æ¥å®ç°** | è¿æ¥åˆ°å·²ç™»å½•æµè§ˆå™¨ï¼Œè§£å†³ç™»å½•é—®é¢˜ | é«˜ |
| 2 | **å›¾ç‰‡ä¸‹è½½** | ä¸‹è½½è¿œç¨‹å›¾ç‰‡åˆ°æœ¬åœ° assets ç›®å½• | ä¸­ |
| 3 | **æµè§ˆå™¨æŒ‡çº¹ä¼˜åŒ–** | æ›´çœŸå®çš„ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ | ä½ |

---

## å…³é”®ä»£ç ä¿®æ”¹ä½ç½®

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œå· |
|------|----------|------|
| `src/core/render/page.ts` | `waitUntil: 'commit'` â†’ `waitUntil: 'load'` + å»¶è¿Ÿ | 24-31 |
| `src/core/render/page.ts` | Debug æ–‡ä»¶ååŠ¨æ€å‘½å | 70-72 |
| `src/core/extract/adapters/twitter/dom-extractor.ts` | æ·»åŠ å¤šæ–¹æ³•æ–‡æœ¬æå– | 16-46 |
| `src/core/extract/adapters/zhihu/index.ts` | ç§»é™¤é—®ç­”é¡µé¢å†…å®¹ä¸­çš„é—®é¢˜æ ‡é¢˜ | 52-59 |
| `src/core/extract/adapters/zhihu/index.ts` | æ·»åŠ  deduplicateTitle æ–¹æ³• | 89-92 |
| `src/core/extract/adapters/zhihu/parser.ts` | æ·»åŠ ä½œè€…åå¤šé€‰æ‹©å™¨ fallback | 74-88 |
| `src/core/export/assets.ts` | å›¾ç‰‡ä¸‹è½½å¾…å®ç° | 19 |
| `src/core/extract/adapters/wechat/*` | æ–°å¢å…¬ä¼—å·é€‚é…å™¨å®ç° | - |
| `src/core/render/browser.ts` | æŒ‰å¹³å°è·³è¿‡ Twitter ç™»å½•æç¤º | - |
| `src/core/export/path.ts` | canonical_url å›é€€ä¸º source_url | - |

---

## æµ‹è¯•éªŒè¯

### Twitter æµ‹è¯•ç»“æœ

```bash
node dist/cli/index.js once "https://x.com/thedankoe/status/2010042119121957316"
```

**ç»“æœ:** âœ… æˆåŠŸ
- æ ‡é¢˜: "Society made you think that having multiple intere..."
- ä½œè€…: @thedankoe
- æ–‡æœ¬: ~2000 å­—å®Œæ•´æå–
- å›¾ç‰‡: 3 å¼ 
- é“¾æ¥: 4 ä¸ª
- äº’åŠ¨: â¤ï¸ 33601 | ğŸ” 6986 | ğŸ’¬ 710

---

### çŸ¥ä¹æµ‹è¯•ç»“æœ

```bash
# é—®ç­”é¡µé¢
node dist/cli/index.js once "https://www.zhihu.com/question/592327756/answer/3379516907"

# ä¸“æ æ–‡ç« 
node dist/cli/index.js once "https://zhuanlan.zhihu.com/p/..."
```

**ç»“æœ:** âœ… æˆåŠŸ
- é—®ç­”é¡µé¢ï¼šç§»é™¤é‡å¤é—®é¢˜æ ‡é¢˜ï¼Œåªæ˜¾ç¤º"é—®é¢˜æ ‡é¢˜ - ç­”ä¸»å"çš„å›ç­”
- ä¸“æ æ–‡ç« ï¼šå®Œæ•´ä¿ç•™æ–‡ç« æ ‡é¢˜å’Œå†…å®¹
- ä½œè€…åï¼šä½¿ç”¨å¤šé€‰æ‹©å™¨ fallback æœºåˆ¶ç¡®ä¿è·å–
- Debug æ–‡ä»¶åï¼šæ ¹æ®å¹³å°åŠ¨æ€å‘½åï¼ˆdebug-zhihu-*, debug-twitter-*ï¼‰

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ:** æµ‹è¯•çŸ¥ä¹é“¾æ¥çˆ¬å–
2. **é«˜ä¼˜å…ˆçº§:** å®ç° CDP è¿æ¥åŠŸèƒ½
3. **ä¸­ä¼˜å…ˆçº§:** å®ç°å›¾ç‰‡ä¸‹è½½åŠŸèƒ½
4. **åç»­å·¥ä½œ:** æ¨è¿›èµ„äº§ä¸‹è½½ä¸é˜Ÿåˆ—/æ‰¹é‡åŠŸèƒ½
